---
- name: Create GCP VPC, Subnets, Firewall Rules, and VM
  hosts: localhost
  gather_facts: yes
  vars:
    project_id: "genuine-episode-443712-e6"
    region: "us-central1"
    vpc_name: "my-vpc-network"
    subnet_1_name: "my-subnet-1"
    subnet_2_name: "my-subnet-2"
    firewall_rule_internal: "allow-internal-traffic"
    firewall_rule_ssh: "allow-ssh"
    firewall_rule_http_https: "allow-http-https"
    network_self_link: "https://www.googleapis.com/compute/v1/projects/{{ project_id }}/global/networks/{{ vpc_name }}"
    service_account_file: "/home/hemant_sharma/playbook/genuine-episode-443712-e6-2c2870146782.json"

  tasks:
    # Authenticate with Google Cloud using the service account credentials
    - name: Set GOOGLE_APPLICATION_CREDENTIALS environment variable
      ansible.builtin.set_fact:
        ansible_env:
          GOOGLE_APPLICATION_CREDENTIALS: "{{ service_account_file }}"

    # Create the VPC network
    - name: Create VPC Network
      google.cloud.gcp_compute_network:
        name: "{{ vpc_name }}"
        auto_create_subnetworks: false
        project: "{{ project_id }}"
        auth_kind: serviceaccount
        service_account_file: "{{ service_account_file }}"

    # Create Subnet 1
    - name: Create Subnet 1
      google.cloud.gcp_compute_subnetwork:
        name: "{{ subnet_1_name }}"
        region: "{{ region }}"
        ip_cidr_range: "10.0.1.0/24"
        project: "{{ project_id }}"
        network: 
          selfLink: "{{ network_self_link }}"
        auth_kind: serviceaccount
        service_account_file: "{{ service_account_file }}"

    # Create Subnet 2
    - name: Create Subnet 2
      google.cloud.gcp_compute_subnetwork:
        name: "{{ subnet_2_name }}"
        region: "{{ region }}"
        ip_cidr_range: "10.0.2.0/24"
        project: "{{ project_id }}"
        network: 
          selfLink: "{{ network_self_link }}"
        auth_kind: serviceaccount
        service_account_file: "{{ service_account_file }}"

    # Create Firewall Rule to allow internal communication within the VPC
    - name: Create Firewall Rule to allow internal traffic
      google.cloud.gcp_compute_firewall:
        name: "{{ firewall_rule_internal }}"
        network: 
          selfLink: "{{ network_self_link }}"
        project: "{{ project_id }}"
        allowed:
          - ip_protocol: "tcp"
            ports:
              - "0-65535"
          - ip_protocol: "udp"
            ports:
              - "0-65535"
          - ip_protocol: "icmp"
        source_ranges:
          - "10.0.0.0/8"
        direction: "INGRESS"
        priority: 1000
        target_tags: []
        state: "present"
        auth_kind: serviceaccount
        service_account_file: "{{ service_account_file }}"

    # Create Firewall Rule to allow SSH (port 22) access from anywhere
    - name: Create Firewall Rule to allow SSH
      google.cloud.gcp_compute_firewall:
        name: "{{ firewall_rule_ssh }}"
        network: 
          selfLink: "{{ network_self_link }}"
        project: "{{ project_id }}"
        allowed:
          - ip_protocol: "tcp"
            ports:
              - "22"
        source_ranges:
          - "0.0.0.0/0"
        direction: "INGRESS"
        priority: 1001
        target_tags: []
        state: "present"
        auth_kind: serviceaccount
        service_account_file: "{{ service_account_file }}"

    # Create Firewall Rule to allow HTTP (port 80) and HTTPS (port 443) access from anywhere
    - name: Create Firewall Rule to allow HTTP and HTTPS
      google.cloud.gcp_compute_firewall:
        name: "{{ firewall_rule_http_https }}"
        network: 
          selfLink: "{{ network_self_link }}"
        project: "{{ project_id }}"
        allowed:
          - ip_protocol: "tcp"
            ports:
              - "80"
              - "443"
        source_ranges:
          - "0.0.0.0/0"
        direction: "INGRESS"
        priority: 1002
        target_tags: []
        state: "present"
        auth_kind: serviceaccount
        service_account_file: "{{ service_account_file }}"

    # Create a VM instance in my-vpc and my-subnet
    - name: Create a VM instance in my-vpc and my-subnet
      google.cloud.gcp_compute_instance:
        name: my-vm-instance-1
        machine_type: n1-standard-1
        zone: us-central1-a
        project: "{{ project_id }}"
        auth_kind: serviceaccount
        service_account_file: "{{ service_account_file }}"
        network_interfaces:
          - network:
              selfLink: "{{ network_self_link }}"
            subnetwork:
              selfLink: "https://www.googleapis.com/compute/v1/projects/{{ project_id }}/regions/{{ region }}/subnetworks/{{ subnet_1_name }}"
            access_configs:
              - name: External NAT
                type: ONE_TO_ONE_NAT
        disks:
          - auto_delete: true
            boot: true
            initialize_params:
              source_image: "projects/ubuntu-os-pro-cloud/global/images/ubuntu-pro-1604-xenial-v20241219"
          - auto_delete: true
            boot: false
            initialize_params:
              disk_size_gb: 10
              source_image: "projects/ubuntu-os-pro-cloud/global/images/ubuntu-pro-1604-xenial-v20241219"
        metadata:
          ssh-keys: |
            dell:ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPYvTBr6T4sdBXH9f3etHX+g6QhF7X99c/izWZ6/OgE0 dell@DESKTOP-EIDLQSO
        tags:
          items:
            - http-server
            - https-server
        labels:
          env: dev
        service_accounts:
          - email: ansible-role@genuine-episode-443712-e6.iam.gserviceaccount.com
            scopes:
              - https://www.googleapis.com/auth/cloud-platform
      register: vm
